# fzf
export FZF_DEFAULT_COMMAND='rg --files --hidden --glob "!.git"'
export FZF_DEFAULT_OPTS='--height 40% --reverse --border'
export FZF_CTRL_T_COMMAND='rg --files --hidden --follow --glob "!.git/*"'
export FZF_CTRL_T_OPTS='--preview "bat  --color=always --style=header,grid --line-range :100 {}"'
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh

fvim() {
  files=$(git ls-files) &&
  selected_files=$(echo "$files" | fzf -m --preview 'head -100 {}') &&
  vim $selected_files
}

fga() {
  modified_files=$(git status --short | awk '{print $2}') &&
  selected_files=$(echo "$modified_files" | fzf -m --preview 'git diff {}') &&
  git add $selected_files
}

fbr() {
  local branches branch
  branches=$(git --no-pager branch -vv) &&
  branch=$(echo "$branches" | fzf +m) &&
  git checkout $(echo "$branch" | awk '{print $1}' | sed "s/.* //")
}

flog() {
  git log --graph --color=always \
      --format="%C(auto)%h%d %s %C(black)%C(bold)%cr" "$@" |
  fzf --ansi --no-sort --reverse --tiebreak=index --bind=ctrl-s:toggle-sort \
      --bind "ctrl-m:execute:
                (grep -o '[a-f0-9]\{7\}' | head -1 |
                xargs -I % sh -c 'git show --color=always % | less -R') << 'FZF-EOF'
                {}
                FZF-EOF"
}

fcd() {
  local dir
  dir=$(find ${1:-.} -path '*/\.*' -prune \
                  -o -type d -print 2> /dev/null | fzf +m) &&
  cd "$dir"
}

brew-maintenance() {
  echo "Starting Homebrew maintenance..."
  brew update
  brew upgrade
  brew autoremove
  brew cleanup
  echo "Done!"
}

_ec2_id_by_name() {
  aws ec2 describe-instances \
    --filters "Name=tag:Name,Values=$1" \
    --query 'Reservations[].Instances[].InstanceId' \
    --output text | awk 'NF{print; exit}'
}

ec2list() {
  aws ec2 describe-instances \
    --query 'Reservations[].Instances[].[
      Tags[?Key==`Name`]|[0].Value,
      InstanceId,
      State.Name
    ]' \
    --output table
}

ec2ls() {
  name_filter="${1:-*}"
  aws ec2 describe-instances \
    --filters "Name=tag:Name,Values=*${name_filter}*" \
    --query 'Reservations[].Instances[].[
      Tags[?Key==`Name`]|[0].Value,
      InstanceId,
      InstanceType,
      State.Name,
      PublicIpAddress,
      PrivateIpAddress,
      Placement.AvailabilityZone
    ]' \
    --output table
}

ec2-ssh() {
  name="$1"
  if [ -z "$name" ]; then
    echo "インスタンス名を指定してください" >&2
    return 1
  fi

  id="$(_ec2_id_by_name "$name")"
  if [ -z "$id" ] || [ "$id" = "None" ]; then
    echo "指定したインスタンスが見つかりません: $name" >&2
    return 1
  fi

  dns="$(aws ec2 describe-instances \
    --instance-ids "$id" \
    --query 'Reservations[0].Instances[0].NetworkInterfaces[0].Association.PublicDnsName' \
    --output text)"

  if [ -z "$dns" ] || [ "$dns" = "None" ]; then
    echo "Public DNS が取得できません（Elastic IP/パブリックIPなしの可能性）" >&2
    return 1
  fi

  echo "SSH接続中: ec2-user@$dns"
  ssh "ec2-user@$dns"
}

ec2-start() {
  name="$1"
  if [ -z "$name" ]; then
    echo "インスタンス名を指定してください" >&2
    return 1
  fi

  id="$(_ec2_id_by_name "$name")"
  if [ -z "$id" ] || [ "$id" = "None" ]; then
    echo "指定したインスタンスが見つかりません: $name" >&2
    return 1
  fi

  state="$(aws ec2 describe-instances --instance-ids "$id" \
    --query 'Reservations[0].Instances[0].State.Name' --output text)"

  if [ "$state" = "running" ]; then
    echo "すでに起動しています: $name ($id)"
    return 0
  fi

  echo "起動中: $name ($id)"
  aws ec2 start-instances --instance-ids "$id" >/dev/null
  echo "起動完了を待機中..."
  aws ec2 wait instance-running --instance-ids "$id"
  echo "起動しました: $name"
}

ec2-stop() {
  name="$1"
  if [ -z "$name" ]; then
    echo "インスタンス名を指定してください" >&2
    return 1
  fi

  id="$(_ec2_id_by_name "$name")"
  if [ -z "$id" ] || [ "$id" = "None" ]; then
    echo "指定したインスタンスが見つかりません: $name" >&2
    return 1
  fi

  state="$(aws ec2 describe-instances --instance-ids "$id" \
    --query 'Reservations[0].Instances[0].State.Name' --output text)"

  if [ "$state" = "stopped" ]; then
    echo "すでに停止しています: $name ($id)"
    return 0
  fi

  echo "停止中: $name ($id)"
  aws ec2 stop-instances --instance-ids "$id" >/dev/null
  echo "停止完了を待機中..."
  aws ec2 wait instance-stopped --instance-ids "$id"
  echo "停止しました: $name"
}

ec2-start-ssh() {
  name="$1"
  if [ -z "$name" ]; then
    echo "インスタンス名を指定してください" >&2
    return 1
  fi

  id="$(_ec2_id_by_name "$name")"
  if [ -z "$id" ] || [ "$id" = "None" ]; then
    echo "指定したインスタンスが見つかりません: $name" >&2
    return 1
  fi

  state="$(aws ec2 describe-instances --instance-ids "$id" \
    --query 'Reservations[0].Instances[0].State.Name' --output text)"

  case "$state" in
    stopped)
      echo "停止中 → 起動します: $name ($id)"
      aws ec2 start-instances --instance-ids "$id" >/dev/null
      echo "起動完了を待機中..."
      aws ec2 wait instance-running --instance-ids "$id"
      ;;
    pending)
      echo "起動中 → 起動完了を待機中..."
      aws ec2 wait instance-running --instance-ids "$id"
      ;;
    running)
      echo "既に起動済み: $name ($id)"
      ;;
    *)
      echo "インスタンスの状態が不明です: $state" >&2
      return 1
      ;;
  esac

  dns="$(aws ec2 describe-instances --instance-ids "$id" \
    --query 'Reservations[0].Instances[0].NetworkInterfaces[0].Association.PublicDnsName' \
    --output text)"

  if [ -z "$dns" ] || [ "$dns" = "None" ]; then
    echo "Public DNS が取得できませんでした" >&2
    return 1
  fi

  echo "SSH接続中: ec2-user@$dns"
  ssh "ec2-user@$dns"
}
